<?php
 namespace App\Http\Controllers; use App\Http\Controllers\Controller; use App\Models\accounts; use App\Models\sale_details; use App\Models\sales; use Illuminate\Http\Request; use Illuminate\Support\Facades\DB; class customerWiseSaleReportController extends Controller { public function index() { $customers = accounts::customer()->get(); return view("\162\145\x70\x6f\162\164\163\56\x63\165\163\164\x6f\155\x65\x72\137\167\151\163\145\x5f\x73\x61\x6c\x65\137\x72\145\160\157\x72\x74\56\151\156\x64\145\170", compact("\x63\x75\x73\164\x6f\155\145\x72\x73")); } public function data(Request $request) { $from = $request->from; $to = $request->to; $customers = accounts::customer(); if ($request->customer) { $customers = $customers->whereIn("\x69\x64", $request->customer); } $customers = $customers->get(); $data = array(); foreach ($customers as $customer) { $sales = sales::where("\143\x75\163\164\x6f\x6d\x65\x72\111\x44", $customer->id)->whereBetween("\144\141\164\x65", array($from, $to))->pluck("\x69\144"); $saleDetails = sale_details::with("\160\162\157\x64\x75\143\x74")->whereIn("\x73\141\154\x65\x73\111\x44", $sales)->get(); $products = array(); foreach ($saleDetails as $product) { $productID = $product->productID; $productName = $product->product->name; $productCategory = $product->product->category->name; $productQty = $product->qty; $productAmount = $product->amount; if (!isset($products[$productID])) { $products[$productID] = array("\x6e\x61\155\x65" => $productName, "\x63\141\164\145\147\x6f\162\171" => $productCategory, "\x73\157\154\x64\x5f\161\164\x79" => 0, "\x74\x6f\x74\x61\x6c\137\141\x6d\157\165\x6e\x74" => 0); } $products[$productID]["\163\157\x6c\x64\137\x71\164\x79"] += $productQty; $products[$productID]["\164\x6f\x74\141\154\137\141\155\x6f\165\x6e\x74"] += $productAmount; } foreach ($products as $pid => $prod) { $sold_qty = $prod["\x73\x6f\x6c\144\x5f\x71\164\x79"]; $total_amount = $prod["\x74\157\164\141\x6c\x5f\141\155\157\165\x6e\164"]; $products[$pid]["\x61\x76\147\137\160\x72\151\x63\x65"] = $sold_qty > 0 ? round($total_amount / $sold_qty, 2) : 0; } $customer->products = $products; $data[] = array("\x63\165\x73\x74\157\155\145\162" => $customer, "\160\162\x6f\144\x75\143\x74\163" => $products); } return view("\x72\145\x70\157\162\x74\163\56\x63\165\163\164\x6f\x6d\145\162\137\x77\x69\163\x65\137\x73\141\x6c\x65\137\x72\x65\160\x6f\x72\x74\x2e\144\x65\x74\141\x69\x6c\163", compact("\144\141\x74\x61", "\x66\162\157\155", "\164\x6f")); } }